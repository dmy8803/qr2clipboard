<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードリーダー</title>

    <!-- スタイル定義 -->
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 50%; /* 画面の上半分の高さに設定 */
            overflow: hidden;
        }

        #preview {
            position: absolute;
            top: 0;
            left: 50%;
            width: auto;
            max-height: 100%;
            transform: translateX(-50%);
            object-fit: contain;
        }

        #results {
            padding-left: 5%;
        }
    </style>

    <!-- jsQRライブラリのCDNリンク -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
</head>

<body>

<!-- カメラの映像を表示するためのvideoエレメントをコンテナでラップ -->
<div class="video-container">
    <video id="preview" autoplay playsinline></video>
</div>

<!-- 保存した値と個数を表示するエリア -->
<div id="results">
    <h3>読み取ったQRコード:</h3>
    <ul id="qr-list"></ul>
    <p><strong>読み取り個数:</strong> <span id="count">0</span></p>
</div>

<script>
    const video = document.getElementById('preview');
    const qrList = document.getElementById('qr-list');
    const countEl = document.getElementById('count');
    let qrCount = 0;
    let scannedCodes = [];

    // カメラのストリームを取得
    navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment'
            }
        }).then((stream) => {
            video.srcObject = stream;
            video.play();

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        setInterval(async () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrCodeResult = jsQR(imageData.data, canvas.width, canvas.height);

                if (qrCodeResult && !scannedCodes.includes(qrCodeResult.data)) {
                    scannedCodes.push(qrCodeResult.data); // 読み取った値を保存
                    const currentClipboardContent = await navigator.clipboard.readText();
                    if (qrCodeResult.data !== currentClipboardContent) {
                        // クリップボードにコピー
                        navigator.clipboard.writeText(qrCodeResult.data);
                        // QRコードの内容を画面に表示
                        const li = document.createElement('li');
                        li.textContent = qrCodeResult.data;
                        qrList.appendChild(li);
                        qrCount++;
                        countEl.textContent= qrCount;
                        // 読み取り成功の音を発生させる (適切な音ファイルを指定してください。)
                        const audio = new Audio('success_sound.mp3');
                        audio.play();
                    }
                }
            }
        }, 100);

    }).catch((err) => {
        console.error("カメラのアクセスに失敗しました:", err);
    });
</script>

</body>
</html>
